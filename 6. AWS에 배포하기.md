

# 6. AWS에 배포하기



## 1. 개별포스트 SSR하기

- 검색엔진이 가져가길 원하는 페이지로 구성을 해야 한다.

- SSR은 View를 서버에서 렌더링해 제공하기 때문에(View를 먼저 그리기 때문에) 상대적으로 SEO(검색엔진 최적화)에 유리해져서 사용자 유입이 CSR보다 많다.

- 만일 SEO를 원하지 않으면 robot.txt를 사용한다.

  -  웹 사이트에 로봇이 접근하는 것을 방지하기 위한 규약으로, 일반적으로 접근 제한에 대한 설명을 robots.txt에 기술한다.

  

## 2. bundle analyze와 빌드

개발모드와 배포모드의 설정을 달리해서 빌드를 진행해야 한다.

### 1) moment 패키지 설치

- 날짜관련 작업을 보기위해 moment 를 설치한다.
- $moment 사용이 가능해진다.

```bash
// front

npm i @nuxtjs/moment
```

#### 1) nuxt.config.js 에 등록한다.

- locales 을 ko로 설정하면 한글이 나온다.

```js
// front/nuxt.config.js

module.exports = {
  buildModules: [
    '@nuxtjs/moment',
  ],
  moment: {
    locales: ['ko'],
  },
}
```

#### 2)  front/content에 사용한다.

- post에 포함된 createdAt 에서 현재 날짜, 시간인 fromNow()로 반환한다.

```vue
// front/components/PostContent.vue

</template>
	<div> {{ $moment(post.createdAt).fromNow() }} </div>
</template>
```

![image](https://user-images.githubusercontent.com/50367487/73262375-55d32680-4211-11ea-9a7b-669e3d73b8fe.png) 

### 2)  nuxt build 후 nuxt serve 하기

- front의 package.json 의 scripts 부분을 수정한다.
  - 개발환경: `"dev": "nuxt --open"`
  - 배포환경: `"prestart": "npm run build", "start": "nuxt start server.js"`

### 3) analyze 적용하기

#### 0) analyze

- 공식문서: https://ko.nuxtjs.org/api/configuration-build/
- 빌드가 제대로 되었는지를 확인할 수 있다.
- 내장되어 있으므로, 추가로 설치할 필요 없다.

#### 1) analyze 설정

- 보고서를 생성해준다. (webpack bundle analyze)

```js
// front/nuxt.config.js

module.exports = {
  build: {
    analyze: true,
  },
}
```

#### 2) analyze 적용 전

```bash
Hash: 0efad37c3397b7619169        
Version: webpack 4.41.5
Time: 22734ms
Built at: 2020-01-19 17:56:30     
                  Asset       Size  Chunks                         Chunk Names
48731a572d0e85b4dd51.js   11.6 KiB       5  [emitted] [immutable]  pages_signup
4df955e9578cdfc402a0.js   79.8 KiB       1  [emitted] [immutable]  pages_hashtag__id_index
61efa271ba6eaf06a4d7.js   32.6 KiB       4  [emitted] [immutable]  pages_profile
73c76f8d290e34f159e6.js   80.5 KiB       6  [emitted] [immutable]  pages_user__id_index
83f01facfbef1133d98f.js   95.7 KiB       2  [emitted] [immutable]  pages_index
fce56402e57d4fbd964a.js   79.4 KiB       3  [emitted] [im              server.js    432 KiB       0  [emitted]              app
   server.manifest.json  435 bytes          [emitted]
Entrypoint app = server.js
```

#### 3) analyze 적용 후 추가되는 문구

- nuxt에서 Gzipped압축을 해준 것을 알 수 있다.
- 프론트에서 gzip 파일을 불러오는 모듈과 웹팩에서 gz으로 압축해주는 플러그인을 적용시키면 무리가 적게 간다.

```bash
// front

npm i compression compression-webpack-plugin
```

```
Webpack Bundle Analyzer saved report to C:\GIT\MY_Github\2. vue-nodebird\ch6\front\.nuxt\stats\client.html
Webpack Bundle Analyzer saved stats file to C:\GIT\MY_Github\2. vue-nodebird\ch6\front\.nuxt\stats\client.json
```

#### 4) 적용 후 화면

![Screenshot 2020-01-28 at 22 58 22](https://user-images.githubusercontent.com/50367487/73270503-24af2200-4222-11ea-8915-6b471a8bd6c0.jpg)

- 만일 nuxt에서 설정한 webpack 설정을 보고 싶다면 아래의 코드를 추가한다.

```js
// front/nuxt.config.js

module.exports = {
  build: {
    analyze: true,
    extend(config, { isServer, isClient, isDev }) {
      // console.log(config, isServer, isClient);
      if (isServer && !isDev) {
        config.devtool = 'hidden-source-map'
      }
    }
  },
}
```



## 3. meta태그와 SSR

- npm start를 하고, network 탭에서 local의 Headers 부분을 보면 아래와 같이 gzip 형식으로 인코딩 된 것을 알 수 있다. (압축이 잘 되었다는 뜻)

```

- Response Headers
Request URL: http://localhost:3081/
Request Method: GET
Status Code: 200 OK
Remote Address: 127.0.0.1:3081
Referrer Policy: no-referrer-when-downgrade
Accept-Ranges: none
Connection: keep-alive
Content-Encoding: gzip
Content-Type: text/html; charset=utf-8
Date: Sun, 19 Jan 2020 09:51:42 GMT
ETag: "4d78c-dGBN4A6yR4VixkRmFQp+Dz/tHtk"
Transfer-Encoding: chunked
Vary: Accept-Encoding
```



## 4. Favicon과 static 폴더 생성



## 5. 도메인 생성 후 Route 53에 등록



## 6. EC2 생성 후 프론트/백엔드 등록

### 0) ubuntu 기본 설치

- `sudo su`
- `sudo apt-get update`
- `sudo apt-get install -y build-essential`
- `(sudo apt-get install curl)`
- `curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash --`
- `sudo apt-get install -y nodejs`
- `node -v`, `npm -v` 로 버전나오는지 확인
- 백엔드의 경우
  - `sudo apt-get install -y mysql-server`
  - `mysql_secure_installation`
  - `mysql -u root -p`

### 1) 프론트 등록하기

- 프론트 인스턴스 접근: `ssh -i "namshter.pem" ubuntu@ec2-3-20-125-129.us-east-2.compute.amazonaws.com`
- 프론트 배포 고정IP주소: http://3.20.125.129/

### 2) 백엔드 등록하기

- 백엔드 인스턴스 접근: `ssh -i "namshter.pem" ubuntu@ec2-3-135-13-152.us-east-2.compute.amazonaws.com`
-    Client does not support authentication protocol requested by server; consider upgrading MySQL client 에러가 발생한다면 아래를 입력한다. 
-   mysql 나가는 건 `exit;`

```mysql
mysql> ALTER USER root@localhost IDENTIFIED WITH mysql_native_password BY '비밀번호';
```

- ~~
- ~~
- 3.135.13.152 주소로 들어가면 `여기는 백엔드`와 함께 연결이 되었다.

### 3) d

### 4) 

### 5) AWS 등록시 resion

- https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/using-regions-availability-zones.html

### 6) S3 bucket PUBLIC으로 변경

```json
{
  "Version": "2012-10-17",
  "Statement": [
      {
          "Sid": "AddPerm",
          "Effect": "Allow",
          "Principal": "*",
          "Action": [
              "s3:GetObject",
              "s3:PutObject"
          ],
          "Resource": "arn:aws:s3:::namshter/*"
      }
  ]
}
```



## 7. pm2 로 관리하기

## 8. 도메인 연결하기

## 9. S3에 이미지 업로드하기

## 10. 람다 함수 만들기

## 11. 람다 배포하기